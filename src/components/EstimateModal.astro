---
// Estimate Request Modal Component
---

<!-- Estimate Request Modal -->
<div id="estimate-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4">
  <div class="bg-gray-700 border-2 border-brand-yellow rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
    <div class="p-6">
      <div id="modal-header" class="flex justify-between items-center mb-6">
        <h3 class="text-2xl font-bold text-brand-yellow">Request a Free Estimate</h3>
        <button id="close-modal" class="text-gray-400 hover:text-white text-3xl leading-none" aria-label="Close modal">&times;</button>
      </div>
      
      <p id="modal-description" class="text-gray-300 mb-6">
        Fill out the form below and we'll contact you back with a free estimate!
      </p>
      
      <form id="estimate-form" action="https://api.web3forms.com/submit" method="POST" class="space-y-4">
        <!-- Name -->
        <div>
          <label for="name" class="block text-white font-semibold mb-2">Name *</label>
          <input 
            type="text" 
            id="name" 
            name="name" 
            required
            class="w-full px-4 py-3 bg-black border border-gray-700 rounded text-white focus:border-brand-yellow focus:outline-none"
            placeholder="First name, last name"
          />
        </div>
        
        <!-- Address -->
        <div>
          <label for="address" class="block text-white font-semibold mb-2">Service Address *</label>
          <input 
            type="text" 
            id="address" 
            name="address" 
            required
            autocomplete="street-address"
            class="w-full px-4 py-3 bg-black border border-gray-700 rounded text-white focus:border-brand-yellow focus:outline-none"
            placeholder="Street address, city, state, zip"
          />
        </div>
        
        <!-- Phone -->
        <div>
          <label for="phone" class="block text-white font-semibold mb-2">Phone Number *</label>
          <input 
            type="tel" 
            id="phone" 
            name="phone" 
            required
            pattern="[0-9]{3}-?[0-9]{3}-?[0-9]{4}"
            title="Please match the requested format (e.g., 904-555-1234 or 9045551234)"
            class="w-full px-4 py-3 bg-black border border-gray-700 rounded text-white focus:border-brand-yellow focus:outline-none"
            placeholder="904-555-1234"
          />
        </div>
        
        <!-- Email -->
        <div>
          <label for="email" class="block text-white font-semibold mb-2">Email *</label>
          <input 
            type="email" 
            id="email" 
            name="email" 
            required
            title="Please match the requested format (e.g., yourname@example.com)"
            class="w-full px-4 py-3 bg-black border border-gray-700 rounded text-white focus:border-brand-yellow focus:outline-none"
            placeholder="your.email@example.com"
          />
        </div>
        
        <!-- Job Description -->
        <div>
          <label for="description" class="block text-white font-semibold mb-2">Job Description *</label>
          <textarea 
            id="description" 
            name="description" 
            required
            rows="5"
            class="w-full px-4 py-3 bg-black border border-gray-700 rounded text-white focus:border-brand-yellow focus:outline-none resize-vertical scrollbar-thin scrollbar-thumb-brand-yellow scrollbar-track-gray-800"
            placeholder="Please describe the stump grinding or tree service you need. Include details like number of stumps, approximate size, and any special considerations."
          ></textarea>
        </div>
        
        <!-- Contact Preference -->
        <div>
          <label class="block text-white font-semibold mb-3">How do you prefer to be contacted? *</label>
          <div class="flex flex-wrap gap-4">
            <label class="flex items-center gap-2 cursor-pointer group">
              <input 
                type="radio" 
                name="contact_preference" 
                value="Text"
                required
                class="w-5 h-5 bg-black border-2 border-gray-600 text-brand-yellow focus:ring-2 focus:ring-brand-yellow checked:bg-brand-yellow checked:border-brand-yellow"
              />
              <span class="text-gray-300 group-hover:text-white transition">Text</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer group">
              <input 
                type="radio" 
                name="contact_preference" 
                value="Call"
                required
                class="w-5 h-5 bg-black border-2 border-gray-600 text-brand-yellow focus:ring-2 focus:ring-brand-yellow checked:bg-brand-yellow checked:border-brand-yellow"
              />
              <span class="text-gray-300 group-hover:text-white transition">Call</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer group">
              <input 
                type="radio" 
                name="contact_preference" 
                value="Email"
                required
                class="w-5 h-5 bg-black border-2 border-gray-600 text-brand-yellow focus:ring-2 focus:ring-brand-yellow checked:bg-brand-yellow checked:border-brand-yellow"
              />
              <span class="text-gray-300 group-hover:text-white transition">Email</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer group">
              <input 
                type="radio" 
                name="contact_preference" 
                value="Any"
                required
                class="w-5 h-5 bg-black border-2 border-gray-600 text-brand-yellow focus:ring-2 focus:ring-brand-yellow checked:bg-brand-yellow checked:border-brand-yellow"
              />
              <span class="text-gray-300 group-hover:text-white transition">Any</span>
            </label>
          </div>
        </div>
        
        <!-- Web3Forms Configuration -->
        <input type="hidden" name="access_key" value="5225be27-8091-4720-85d5-36e4badcea83" />
        <input type="hidden" id="form-subject" name="subject" value="New Estimate Request" />
        <input type="hidden" name="from_name" value="Stump Masters Jax Website" />
        <input type="hidden" name="redirect" value="false" />
        
        <!-- Privacy Disclaimer -->
        <div class="pt-4 pb-2 border-t border-gray-700">
          <p class="text-xs text-gray-400 leading-relaxed">
            <strong class="text-gray-300">Privacy Notice:</strong> By submitting this form, you authorize Stump Masters Jax to contact you via phone, text, or email regarding the services described above. We respect your privacy and will only use your information to provide you with an estimate and related services. We do not sell, share, or store your personal data beyond what is necessary to fulfill your service request.
          </p>
        </div>
        
        <!-- Form Actions -->
        <div class="flex gap-4 pt-2">
          <button 
            type="submit"
            class="flex-1 px-6 py-3 bg-brand-yellow text-black font-bold rounded hover:bg-yellow-400 transition"
          >
            Submit Request
          </button>
          <button 
            type="button"
            id="cancel-modal"
            class="px-6 py-3 bg-gray-700 text-white font-bold rounded hover:bg-gray-600 transition"
          >
            Cancel
          </button>
        </div>
      </form>
      
      <!-- Success Message (hidden by default) -->
      <div id="success-message" class="hidden mt-6 p-8 bg-black border-4 border-brand-yellow rounded-lg shadow-2xl">
        <div class="text-center">
          <div class="inline-block p-4 bg-brand-yellow rounded-full mb-4">
            <svg class="w-12 h-12 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
            </svg>
          </div>
          <h4 class="text-3xl font-bold text-brand-yellow mb-3">Quote Submitted Successfully!</h4>
          <div class="w-24 h-1 bg-brand-yellow mx-auto mb-4"></div>
          <p class="text-white text-lg leading-relaxed mb-6">
            Thank you for your request. We've received your information and will be reaching out to you shortly with your free estimate. We look forward to serving you!
          </p>
          <a 
            href="/"
            class="inline-block px-8 py-3 bg-brand-yellow text-black font-bold rounded-lg hover:bg-yellow-400 transition"
          >
            Return to Homepage
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Modal functionality - runs on every page that includes this component
  function initEstimateModal() {
    const modal = document.getElementById('estimate-modal');
    const closeBtn = document.getElementById('close-modal');
    const cancelBtn = document.getElementById('cancel-modal');
    const form = document.getElementById('estimate-form');
    const successMessage = document.getElementById('success-message');
    const modalHeader = document.getElementById('modal-header');
    const modalDescription = document.getElementById('modal-description');
    
    // Find all buttons that should open the modal
    const openButtons = document.querySelectorAll('[data-open-estimate-modal]');
    
    function openModal() {
      if (modal) {
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      }
    }
    
    function closeModal() {
      if (modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = '';
        form?.reset();
        successMessage?.classList.add('hidden');
        // Show header and description again
        modalHeader?.classList.remove('hidden');
        modalDescription?.classList.remove('hidden');
      }
    }
    
    // Attach click handlers to all open buttons
    openButtons.forEach(button => {
      button.addEventListener('click', openModal);
    });
    
    // Close button
    if (closeBtn) {
      closeBtn.addEventListener('click', closeModal);
    }
    
    // Cancel button
    if (cancelBtn) {
      cancelBtn.addEventListener('click', closeModal);
    }
    
    // Escape key to close
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal && !modal.classList.contains('hidden')) {
        closeModal();
      }
    });
    
    // Handle form submission
    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        // Check if form is valid using HTML5 validation
        if (!form.checkValidity()) {
          // Show validation messages without closing modal
          form.reportValidity();
          return;
        }
        
        // Update subject line with actual customer data
        const nameField = document.getElementById('name');
        const addressField = document.getElementById('address');
        const subjectField = document.getElementById('form-subject');
        
        if (nameField && addressField && subjectField) {
          const customerName = nameField.value;
          const customerAddress = addressField.value;
          subjectField.value = `New Estimate Request - ${customerName} / ${customerAddress}`;
        }
        
        const formData = new FormData(form);
        
        // Show loading state
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn?.textContent;
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.textContent = 'Sending...';
        }
        
        try {
          const response = await fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
              'Accept': 'application/json'
            }
          });
          
          if (response.ok) {
            form.classList.add('hidden');
            successMessage?.classList.remove('hidden');
            // Hide header and description when showing success
            modalHeader?.classList.add('hidden');
            modalDescription?.classList.add('hidden');
            
            // Track conversion
            if (typeof trackEvent === 'function') {
              trackEvent('Submit', { category: 'Form', label: 'Estimate Request' });
            }
            
            // Auto-close after 5 seconds
            setTimeout(() => {
              closeModal();
              form.classList.remove('hidden');
            }, 5000);
          } else {
            throw new Error('Form submission failed');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('There was an error submitting your request. Please call us at 904-408-2450 instead.');
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
          }
        }
      });
    }
  }
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initEstimateModal);
  } else {
    initEstimateModal();
  }
</script>
